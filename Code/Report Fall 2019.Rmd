---
title: "Report--Fall 2019"
author: "Rachel Weber"
date: "September 4, 2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

library(anytime)
library(CIDAtools)
library(tidyverse)
library(magrittr)
library(pander)
library(ggplot2)
library(gridExtra)
library(wesanderson)
library(scales)
```

```{r}
shoot <- read.csv(file = "C:/Users/rache/Documents/Capstone/Data/NYC_extracolumns.csv")

shoot$OCCUR_DATE <- anytime(shoot$OCCUR_DATE)
```
### Background
NYC shooting data is publicly available for access through https://data.cityofnewyork.us/Public-Safety/NYPD-Shooting-Incident-Data-Historic-/833y-fsy8. The data are updated annually and contain data from January 1, 2006 to December 31, 2018. In this time `r nrow(shoot[!is.na(shoot$PRECINCT),])` shootings occured. Their date, time, precinct, borough, and location are available along with perpetrator and victim age, race, and sex.
The weekend of october 12th, 2018 was the first shooting-free weekend the city has had 25 years. This headline made national news and being familiar with the law of truly large numbers, the question arose asking, "Was this truly a newsworthy event or was it bound to happen?"
Figure 1 below shows the number of shootings stratified by year (left) and by season (right). Shootings have been reportedly going down in recent years, so a shooting-free weekend may be becoming more likely. Additionally, shooting rates change with the season, peaking in summer, so the probability of a shooting-free weekend may change with the season.
```{r}
# shoot$year <- as.factor(shoot$year)
# 
# table1 <- Table1(c("year", "season"), NULL,
#                  data = shoot[!is.na(shoot$INCIDENT_KEY),], incl_missing = F)
# set.alignment("center", row.names="left")
# pander(table1, caption = "")

```

```{r, fig.width= 7}
# a graph showing number of shootings over the years
g1 <- ggplot(shoot[!is.na(shoot$INCIDENT_KEY),], aes(x = factor(year))) + geom_bar() + 
        geom_text(stat='count', aes(label=..count..), vjust=-1) +
        ggtitle("N Shootings by Year") + theme_minimal() +
        xlab("Year") + ylab("N shootings") + ylim(0,2500)
# a graph showing shootings over seasons
g2 <- ggplot(shoot[!is.na(shoot$INCIDENT_KEY),], aes(x = factor(season), fill = season)) + geom_bar() + 
        geom_text(stat='count', aes(label=..count..), vjust=-1) +
        ggtitle("N Shootings by Season") + theme_minimal() +
        xlab("Season") + ylab("N shootings") + ylim(0,7200)
g1
g2
```

### Analysis
One cannot assume that shootings on Saturday are completely independent of shootings on Friday. As such, we cannot multiply the days' probabilities together to get our weekend probability. The definition of conditional probability though, does not necessitate independence and can be used here. The probability of a shooting-free weekend was calculated as follows:

$P(\text{No Shooting Friday})=P(F)=\frac{\text{total Fridays without shootings}}{\text{total Fridays in 5 years}}=\frac{16}{985}=0.016$

$P(\text{No shooting Saturday given no shooting Friday})=P(Sat|F)=\frac{P(Sat \cap F)}{P(F)}=.0032$

$P(\text{No shooting Sunday given none Saturday AND Friday})=P(Sun | Sat\cap F)=\frac{P(Sun\cap Sat \cap F)}{P(Sat \cap F)}= \frac{P(Sun\cap Sat \cap F)}{P(Sat | F)}=\frac{P(Sun\cap Sat \cap F)*P(F)}{P(Sat\cap F)} 1.5*10^{-4}$

Therefore, the probability of our full weekend being shooting-free is:

$P(Sun|Sat \cap F)*P(Sat | F)*P(F)= 1.5*10^{-4}*.0032*.016=7.69*10^{-9}$

The probability comes to be astoundingly small. The odds of a shooting-free weekend given the last 5 years of data are about 7 is a billion. The odds of winning the Powerball jackpot are 1 in 292 million.

We calculated this assuming that Sundays shooting aren't independent of Fridays shootings. But how affected is it really. In the table below, we explore how our odds change given previous days' shooting totals.

```{r}
# P(no shooting Friday)
pf <- nrow(shoot[shoot$day == "Friday" & is.na(shoot$OCCUR_TIME),])/nrow(shoot[shoot$day == "Friday",])

# P(shooting Friday)
pfs <- nrow(shoot[shoot$day == "Friday" & !is.na(shoot$OCCUR_TIME),])/nrow(shoot[shoot$day == "Friday",])

# P(no shooting Saturday)
psat <- nrow(shoot[shoot$day == "Saturday" & is.na(shoot$OCCUR_TIME),])/nrow(shoot[shoot$day == "Saturday",])

# P(shooting Saturday)
psats <- nrow(shoot[shoot$day == "Saturday" & !is.na(shoot$OCCUR_TIME),])/nrow(shoot[shoot$day == "Saturday",])

# P(no shooting Sunday)
psun <- nrow(shoot[shoot$day == "Sunday" & is.na(shoot$OCCUR_TIME),])/nrow(shoot[shoot$day == "Sunday",])

#P(no Sun and no Sat and no Fri)
p_ind_weekend <- pf*psat*psun

# P(no Sat | no Friday) = P(Sat and Fri)/P(Fri)
p_f_sat <- scientific(psat*pf/pf, digits = 3)

# P(no Sat | yes Friday) = P(no Sat and yes Fri)/P(yes Fri)
p_f_sats <- scientific(psat*pfs/pfs, digits = 3)

# P(no Sun | no Sat) = P(Sat and Sun)/P(Sat)
p_sat_sun <- scientific(psun*psat/psat, digits = 3)

# P(no Sun | yes Sat) = P(yes Sat and no Sun)/P(yes Sat)
p_sat_suns <- scientific(psun*psats/psats, digits = 3)

# P(Sun | Sat and Fri) = P(Fri and Sat and Sun)/P(no Sat and no Fri)=
                        # p(Fri and Sat and Sun)P(Fri)/p(Sat and Fri) by conditional probability
pfss <- ((psun*psat*pf)*(pf))/(psat*pf)
p_f_sat_sun <- scientific(pfss, digits = 3)

# P(Sun | yes Sat and no Fri) = P(Fri and yes Sat and Sun)/P(yes Sat and no Fri)=
                        # p(no Fri and yes Sat and Sun)P(no Fri)/p(yes Sat and no Fri) by conditional probability
pfss <- ((psun*psats*pf)*(pf))/(psats*pf)
p_f_sats_sun <- scientific(pfss, digits = 3)


# P(no Sun | no Sat and yes Fri) = P(yes Fri and Sat and Sun)/P(no Sat and yes Fri)=
                                  # p(yes Fri and Sat and Sun)P(yes Fri)/p(Sat and yes Fri)
pfss <- ((psun*psat*pfs)*(pfs))/(psat*pfs)
p_fs_sat_sun <- scientific(pfss, digits = 3)

# P(no Sun | no Sat and yes Fri) = P(yes Fri and yes Sat and Sun)/P(yes Sat and yes Fri)=
                                  # p(yes Fri and yes Sat and Sun)P(yes Fri)/p(yes Sat and yes Fri)
pfss <- ((psun*psats*pfs)*(pfs))/(psats*pfs)
p_fs_sats_sun <- scientific(pfss, digits = 3)


t <- matrix(nrow = 7, ncol = 3)
colnames(t) <- c("Friday", "Saturday", "Sunday")
rownames(t) <- c("P(0)", "P(0|0)", "P(0|1)", "P(0|0,0)", "P(0|0,1)", "P(0|1,0)", "P(0|1,1)")
t[1,1] <- scientific(pf, digits = 3)
t[1,2] <- scientific(psat, digits = 3)
t[1,3] <- scientific(psun, digits = 3)
t[2,2] <- p_f_sat
t[2,3] <- p_sat_sun
t[3,2] <- p_f_sats
t[3,3] <- p_sat_suns
t[4,3] <- p_f_sat_sun
t[5,3] <- p_fs_sat_sun
t[6,3] <- p_f_sats_sun
t[7,3] <- p_fs_sats_sun

pander(t)
```

The odds of a shooting-free Sunday when we're looking at just Saturdays data--row 2--and when we're also including friday are nearly identical. This would imply that our estimate for Sunday doesn't depend of Friday's shooting status. However, look at what happens when we compare odds of shooting-free Sundays given that Saturday had at least 1 shooting. Knowing that Friday was shooting-free increased our probability for Sunday a full order of magnitude. Is this difference significant? One could argue no. We're comparing odds of .00922 to .00015. Both are vanishingly small. So can be assume independence of Sunday from Friday? Well, it depends. I'll explore that later.


```{r, include = F, echo = F}
# Let's move into model building. Performing regression on our outcome of interest may shed more light than working with conditional probabilities. First I fit a cell means model using Day, Year, and Season as predictors of number of shootings in a given day. This value ranged from 0 to 19 in the 5 years of data used here.

test <- shoot %>% 
  group_by(OCCUR_DATE) %>% 
  dplyr::summarise(n_shootings = n())
shoot <- left_join(shoot, test)
shoot$n_shootings <- as.double(shoot$n_shootings)

shoot$yn_shoot <- case_when(is.na(shoot$OCCUR_TIME) ~ 0,
                            !is.na(shoot$OCCUR_TIME) ~ 1)
shoot$n_shootings <- case_when(shoot$yn_shoot == 0 ~ 0, 
                               TRUE ~ shoot$n_shootings)

# get 1 row per person
short <- shoot[!duplicated(shoot[2]),]
short$num_year <- as.numeric(as.character(short$year))

m1 <- glm(n_shootings ~ 0 + day + num_year + season, data = short)
pander(summary(m1))

# The model suggests that knowing the day of the week is important in predicting how many shootings are likely to occur. It being summer is predicted to increase the number of shootings by just over 60% and it being  is predicted to lower the number of shootings by about 1 shooting.
```


We're interested in whether or not there is a shooting on a given day. We can model this with logistic regression:

```{r}
m2 <- glm(yn_shoot ~ 0 + day + year + season, data = short, family = "binomial")
pander(summary(m2))
```

Our results suggest that season does not impact whether a given day has a shooting and that having the day be in 2017 is associated with reduced odds in a shooting occuring.

